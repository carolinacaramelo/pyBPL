#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Wed Nov  9 17:16:15 2022

@author: carolinacaramelo
"""

import torch
import numpy as np
import pandas as pd

import scipy
from scipy.cluster.hierarchy import dendrogram,linkage

import matplotlib.pyplot as plt

from sklearn.decomposition import PCA


################### GETTING THE DATAFRAME READY WITH DATA FROM INFERENCE AND GENERATIVE PROCESSES#######
def read():
    list_final = []

    with open("./list_ids_omniglot") as f:
        lines = f.readlines()
        
    for l in lines:
        l = l.replace("/n", "").replace("tensor([","").replace(")]", "").replace("[","").replace("]","").replace("(","").replace(")","")
        l1 = l.split(",")
        l1[-1] = l1[-1].strip()
        res = [eval(i) for i in l1]
        list_final +=[res]
    return list_final
        
def data_frame_omni(list_final):
    corpus_omni = pd.DataFrame(columns=['id', 'sequence'])
    for l in range(len(list_final)):
        d = pd.DataFrame([["char_omni_%d"%l, list_final[l]]],columns=['id', 'sequence'])
        corpus_omni = corpus_omni.append(d)
    return corpus_omni

def data_frame_perturbed():
    list_per = [[714,131],[541],[579],[574],[662],[574,714,541],
                [541,574],[131],[574],[574,131,131],[541,574],[775],
                [541,686],[131],[145,541,131,541,662],[131,714],[574,541,131],
                [574,574,145],[40],[574],[131,541],[232,409],[131],[541],[714],[525],
                [401],[955,677,275],[955,955,795,873,525],[401,126],[401,525,275],
                [401,955],[525,275],[401,955],[525,955,126],[525,275,666,504],[275,401,401],
                [282,955],[525],[401,54,401,955,401],[401,955,955,955],[525,275,84],[955],[275],
                [955,275,666,275],[401,401], [1061, 440, 1170, 1179,1061], [46,1131,17],[17,36],
                [1061,511],[17,1061],[36,820,17],[511,17],[17,159,1061,838,1061],
                [17, 274, 1061], [1061,1061],[17,351,17],[17,625,710],[820,17,274],
                [159,17,1061, 17, 923, 136, 252, 36], [1061,1061, 39, 1083, 269],
                [17, 274, 162, 296, 838],[17,17,838,820],[625,31,1061],[511,820,1061,17,46],
                [17,1061],[1061,159],[1061,17],[17,46],[1061,17,1061, 577, 988, 199, 189, 763, 17, 1061],
                [645,881],[64],[587,219, 1038],[645],[863],[881,645,114,114],[64, 676, 183,64],[64],[587,881,64,645,1055],[114,881,863,724,64],
                [645,881],[64],[1056,881,881,219],[863,611],[219,611],[1056,219,645,64,64], 
                [1056,863,863],[881],[188,645,1055],[645,587],[64],[64,881,645,140,274,1056],
                [724,881], [516,455],[409,946,409,621,214],[409,980, 409,409],
                [621,621,980],[827,1196,409,409],[621,481],[409,409,827,621],
                [133,621,409,827],[10,621,813,557],[621,90,214],[621,290,409,409],
                [621,621,214],[409,352,409,621],[621,621,621,409],[353,621,827,621],[409],[409,621,621,621],
                [516,409],[621,621,621],[621,306,827,409],[214,409,621,10],[621],[5,214],
                [409,827,621,15],[409,621,10],[938],[349],[1008,576],[1008],[162],[210],
                [938,1008],[162,1075,938],[938,938,1048],[1008,384, 1048],[162,938,339],[938,162],
                [938,938],[938],[162,590,118,1100],[351,259],[349],[162,938,149],[339,162,938],
                [1008,576,228,1110],[1048],[1008,679],[938,938],[938,118],[938,162,339],
                [268,582,481],[268,8],[821,99],[268,1016],[8,182],[520,268],[520,268],
                [220,8,99,99,335],[520,63,582],[182,582],[70,1146],[182,182, 1128, 885, 728,582,582],[8,582],[582,481,182,1016,582,401],
                [182,268],[182,582],[268,19],[99,99],[520,263,8],[978,480,520,791,582],
                [520,182],[268,749,268, 771, 294, 949, 220, 268],[182,19],[268, 268, 1152, 1095, 239, 906, 884, 386, 905, 1198,582, 779, 1062, 55, 268, 749],[8,520,268], 
                [209,800],[277],[747],[526, 800, 64, 754, 761, 721, 582, 1035],[277,811,280,657],[657],
                [526,84,657,800],[84],[2],[307,2,800,657],[526],[307],[443],[526,84,292],[526],[209, 1140, 279, 897, 758, 419, 578, 747],[526],[800],[800],[811],[209],[657],[800],[84,811,209,209],[800],[536,700,298,100],[100,161],[44,100],[100,344],[100,331],[44,100],[344,344],[100,44],[752,100],[44,752],[100,19],[100,115],[21,536],[100,921],
                [536],[100,19,344,100,344,259],[44,100,100],[100,259],[344],[100,100],[331,331,100,497,383, 921, 75, 1126, 115, 563, 918, 807, 444, 100],[100,19],[19,331],[259,921],[75,331], [1033,756,756,756],[756,892],[473,420,805],[826,128],[179,678],[756,495,514,859,1046,826,1034, 390, 845, 136, 420],
                [147, 892, 57, 896, 358, 573, 420, 342, 681, 255, 1173],[179,1187,420, 869, 742, 1166, 565, 1113],[756, 27, 319, 1113, 116, 805,805],[420,885],[756,892,756],
                [892, 1111, 1202, 653, 992, 869, 473],[892, 756, 503, 416, 456, 820, 1033],[756,756,756,179],[756],[383,473],[756,885],[756, 1184, 1052, 330, 844, 473, 381, 472, 515, 638, 756, 0, 387, 64, 624],[869,420],[756,892,756],[756, 27, 531, 1091, 549, 166,756],[756,128,756,756],[756,756],[179,869],[892,420],
                [1087,330],[1155,774],[908,518,1177,1155,1155,1087,93,723,908],[1087,1019, 511],[528,64,189],[908,908,1155],[18,951],[730,1155,54,774,54,1155,774,330,1155],[458,1155,1087,511,54,54,518,54,535],[1155],[1155,6],[93],[93],[1155,1087],[1019,518,225],[1087,774,720,929],[774, 783, 811, 559, 518, 511, 1038, 33, 171],[518, 1155, 54, 68, 1211, 1210],[730,54, 68, 1211, 965, 1155, 1167, 1075, 618],[1155, 294, 93],[774],[730, 458],
                [1155, 518, 54, 908, 511, 18, 518, 518, 54],[93, 3, 333, 950, 54, 93],[518,518,93,730], [345],[21],[671],[456],[671],[671],[671],[345,671],[456],[47,1080, 831],[345,345,345],[399, 799],[244],[345],[671],[380,380,159],[380],[345],[345],[456],[541],[380],[546],[546,393,456,345],[47,399],[1153, 973],[1204,973,1190],[621],[1081,21,337, 1180, 158, 468, 695, 639, 695, 639, 62, 197],[337,337,1204,337],[337, 1194, 973, 136, 973, 337, 892, 1204, 57],[1190],[337, 695],[1153, 973,337],[337, 337, 337],[1204, 57, 99, 1140, 621, 973],[621],[337, 1065, 337],[337],[695, 77],[973, 308,337],[973, 308, 1153, 379, 883, 1131, 1204, 541, 1204],
                [1204, 973, 1204, 136, 695, 77],[621],[337],[1153, 973, 19],[973, 337, 337, 695, 982, 200, 1204],[973, 337, 337],[621, 516, 973, 619, 337, 1180, 1190, 973],[695, 337],[778, 538, 60],[1, 419, 857],[60,1],[442, 933, 1106, 352, 442, 857],[60],[419],[419,60,1],[419,419,419],[778],[14,14],[442, 978],[419,442,60],[1068,419,14, 379, 1006, 835],[1],[60,620, 442],[442, 60],[854],[60,442],[1068],[1],[1,60],[857, 778, 419],[60],[778, 678, 732, 715, 857, 60],[442,442,442], [925, 220,1034, 220, 759, 220],[301, 1121],
                [220,220,893,220],[925],[111],[220,220],[220,220, 55,160], [925, 1124],[925,925,925],[925],[925,160],[925],[844],[925,925,330,220],[563],[55],[220],[111],[925, 301, 925, 563],[220],[13,11,984,13],[220],[925,205],[220],[1104, 0, 153],[0, 1148, 592, 0],[1148],[1148, 700, 700, 163],[0,761,700,1148],[1148, 672, 1148, 1148],[1104, 1173, 153],[153],[1148, 7, 1148],[7,0,153],[7, 745, 125, 473, 49],[185],
                [1148],[1148, 0, 79],[7, 424, 398, 885, 1155], [700, 305, 123, 236, 597], [1173, 7, 79],[1148, 1148, 7],[1148],
                [1148, 199, 1148],[1148, 672, 1148, 1104],[185],[7],[238, 1148],[7, 1013, 1133, 523, 212], [1, 677, 1163, 1030, 487, 149],[189, 286, 189],[189,600,189,600],[600,189],[600,189,677,189],[17, 189, 731, 353, 16, 607],[677, 600],[189,189,1101,600],[1],[600,189,600,600],[189],[600,87,166],[87, 14, 263, 12, 76, 189],[189, 677],[189,87],[600,677],[600,189],[1101, 189, 600, 776],[600, 189, 600, 166],
                [1101, 391, 189, 286, 420, 776, 609, 600],[166, 189, 600, 189],[189,189],[189, 1053, 65, 207, 880, 6],[600, 1197],[600,677],[1062, 8],[1177],[1062,1177, 527],[8,265, 308, 527],[2, 417, 1177, 375],[1062],[1177, 695, 1177],[8,527],[632, 695, 632],[632, 8],[632, 695, 915, 1177],[695],[373],[695],[695,695],[1177],[695],[8,373],[1177],[1208],[527,59,1062,707,117],[1177, 707, 186, 632],[1062, 2, 949, 1177],[59],[632],[944, 887, 434, 901],[901],[806, 318],[434, 439, 318, 707, 69], [944, 1087, 531],[52],[5],[901,113],[901, 678, 887, 30, 184, 796, 559], [737, 52],[678, 901],[52, 130, 859, 901, 373, 961, 594, 1046, 63, 434, 648],[52, 406],[901],[678, 52],[944],[678, 720, 1010, 492, 835], [678],[678],[901],[531],[806],[678, 944, 406, 944],[944],[648],[402, 7],[7, 876],
                [402, 303],[835, 835],[402, 7],[335, 402],[7, 747],[747, 402, 747],[335],[402],[402, 170],[556, 717],[170, 7, 303, 57],[556, 747],[876, 7],[402, 7],[1056, 10],[402],[402],[7, 402],[ 7, 553],[7, 747],[7, 402],[402, 747],[747, 7],[1167, 139, 1167, 1167],[289, 1167],[1167, 356], [139, 139, 1167, 139],[735, 289],[1167],[1167, 714, 1167, 784],[190, 139, 1167, 139],[139, 1167, 139, 190],[1167],[139],[1167, 356, 1167], [139, 1112, 255, 1174, 139, 1167, 139],[1167, 1167, 139, 1167],[1167, 190, 1167, 1167],
                [1167, 139, 951, 238],[1167],[1167,1167,1167],[1167, 1167, 139,139],[190, 1167, 784],[289, 1167, 289],[706, 190, 784, 1167],[1167, 1167, 139],[3,1130,1167],[139],[385],[10, 735, 709, 742], [83], [83, 826, 862, 528], [275], [10], [11], [963], [10], [83], [11, 701, 932, 142, 10, 274],[10, 644, 11, 701, 124, 170], [249, 166], [401], [10], [10,11, 963],[11,11,11,],[83],[83, 161, 83, 826],[963, 249, 11],[83],[83, 83, 385, 83],[83],[83, 954, 573, 176], [10], [297, 297, 113],[113],[113, 543, 113],[113, 1188, 543, 113, 319, 976],[787, 297, 855, 545],[113],[297, 105, 113, 113],[113, 113, 319, 1188],[543],[355, 566, 113, 180],[113, 38, 113],[543, 515, 203, 297],[113],[1188],[113, 297],[113, 543, 106, 965], [113, 543, 1188, 113],[566, 135, 1160, 1103, 741, 462, 1006, 337, 129, 113],[1188], [180], [113, 962, 113, 113],[543],[543, 472, 355, 543],
                [113, 543, 113, 566],[180, 180, 900, 1116],[16, 529, 1159, 525, 545, 284], [54, 70, 306, 529, 512, 228],[313, 12, 1010],[12],[751, 392],[313],[751, 54, 54, 522],[260, 106, 529, 447],[1192],[392, 350, 116, 751, 866, 116],[751],[54],[54, 751],[ 12, 116, 12], [116],[942, 527, 293],[313, 313, 674],[54, 751, 529, 949],[260],[116],[529, 54],[54, 1029, 313, 95, 116, 301],[260],[313, 260],[493],[387, 915, 370, 0],[176, 254],[73, 46, 1039],[387],[162, 46],[976, 304, 262, 254],[254],[176],[254, 387],[ 176],[976],[254, 771, 459, 1046], [976],[176],[176],[254],[176, 176],[0],[176, 162],[387, 73],[176, 800, 981, 214], [162, 1019, 73, 345],[976, 162],[176, 884, 176, 387, 176],[176, 884], [65, 334, 234, 334],[234, 191, 820, 434, 970],[334, 191, 208],[334, 65, 65],[234, 334, 1058, 1058],[931, 65, 334],[65, 1058, 24],[1058, 234, 379, 234, 234, 65, 234, 797, 1058],[234, 234],[234, 234, 234],[1058, 65, 970],[65, 48, 65],[191, 208],
                [334, 334, 48, 334],[48, 234, 1058],[334],[294, 65, 48],[191, 234, 970],[931, 1058, 234, 65],[98, 931, 191, 334],[65],[234, 48, 234],[234, 65, 65, 234],[65],[65],[367, 1051, 812, 318, 483, 114], [571], [855, 637, 728, 1089, 247, 705], [855, 618, 389, 846, 408, 799], [752], [571, 571, 855, 1205, 367, 1051],[571],[571, 922], [855], [855, 570, 1, 1085, 315, 204], [855], [855], [855], [855, 903, 571, 11], [367, 1051, 354, 193, 61],[571, 855, 855],[855, 855, 82, 895, 571], [855], [752, 754, 571],[571, 130, 855, 571],[754, 855],[855, 1160, 130, 360],[855, 367, 571, 855, 855],[855],[130, 360, 1048, 421, 632, 887], [410, 410],[410, 756],[410, 410, 756],[410, 1166, 485, 24, 664],[410,410,410],[485, 413, 782, 898,756],[410, 107, 410],[410,410,308,410,664],[756, 410, 24],[756,1057,410, 825], [655, 7, 942, 1025, 756],[756, 410],[410,410,410,756],[632, 410, 825, 846, 293], [632, 657, 186, 249, 410, 410],[410,410],[186,442],[664, 764], [410,756],[410, 756, 664],[186, 756, 632, 664, 119, 664],[24],[410],[664,410],[485, 756, 664],[761], [79,80,79,287],[79, 68, 1, 562],[230, 742, 1193, 213], [1], [79,79],[68,79],[259, 79,717],[79,717,79],[68,116,90,68],[68],[68,1193,1],[567, 639],[1],[79,717],[79,825, 68],[79,68],[1193, 68],[79, 717,68],[68, 79,79],[68, 1164],[68, 79, 270],[68,79,79],[230,742,79,717],[79,717], [868, 431, 590, 431],
                [1013, 431, 1013, 431, 1006, 51, 988, 1079], [712, 904],[712, 431, 867, 1119, 404, 162, 712, 712],[431],[904, 590, 93, 887, 956, 388, 712, 431, 396, 345, 30, 381], [431, 963, 431, 431],[431, 963,98,963],[431, 1013, 98, 904, 9, 498, 418, 534], [431, 778, 431, 904],[431, 431, 358, 904],[98, 431, 590, 26],[1013, 431, 396, 436],[868, 431, 634, 279], [98, 98, 662, 497, 182, 509, 478, 431],[98, 431, 431, 963],[431, 712],[963, 358, 63, 955, 904,26],[712, 98],[778, 431, 98, 431],[431, 431, 868, 431],[431, 304, 443, 1013, 207, 431, 590, 904],
                [590, 778, 590, 778],[431, 197, 98, 431]]
    corpus_per = pd.DataFrame(columns=['id', 'sequence'])
    for l in range(len(list_per)):
        d = pd.DataFrame([["char_per_%d"%l, list_per[l]]],columns=['id', 'sequence'])
        corpus_per = corpus_per.append(d)
    return corpus_per
    
def data_frame_final(d1,d2):
    d1 = d1.append(d2)
    return d1        


#################3 HIERARCHICAL CLUSTERING #####################################################

from sklearn.cluster import AgglomerativeClustering
import pandarallel
import sgt
sgt.__version__
from sgt import SGT


def dendogram(corpus):
    print(corpus)
    
    #embedding sequences 
    sgt_ = SGT(kappa=1, 
               lengthsensitive=False, 
               mode='multiprocessing')
    sgtembedding_df = sgt_.fit_transform(corpus)

    print(sgtembedding_df)

    sgtembedding_df = sgtembedding_df.set_index('id')
    labels = sgtembedding_df.index
    print(labels)
    
    Z = linkage(sgtembedding_df, 'ward')
     
    print(Z)
    print("Z shape", Z.shape)
      
    fig, ax = plt.subplots(figsize=(12,8))
    plt.title("Clustering Omniglot characters vs. Perturbed characters")
    dendrogram(Z, labels=labels)      # Call dendrogram on Z
    plt.show()
    
    return sgtembedding_df
    
    
def pca(sgtembedding_df):
    

    #performing PCA 
    pca = PCA(n_components=2)
    pca.fit(sgtembedding_df)
    
    X=pca.transform(sgtembedding_df)
    
    print(np.sum(pca.explained_variance_ratio_))
    df = pd.DataFrame(data=X, columns=['x1', 'x2'])
    print(df)

    W =  linkage(df, 'ward')
    
    fig, ax = plt.subplots(figsize=(12,8))
    plt.title("Ward")
    dendrogram(W)      # Call dendrogram on Z
    plt.show()
    
    return df
    
def hierarchical_clustering(sgtembedding_df,df):


    hierarchical_cluster = AgglomerativeClustering(n_clusters=2, affinity='euclidean', linkage='ward')
    labels = hierarchical_cluster.fit_predict(sgtembedding_df) 
    print(labels)
    
    
    plt.figure(figsize=(10, 7))  
    plt.scatter(df['x1'], df['x2'], c=labels) 
    plt.show()




